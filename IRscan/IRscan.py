# Opening serial connection...
# Serial connection opened!
# Input buffer cleared
# Initializing monitors...
# Ready to start panning!
# ==================================================
# DEBUG: Loop | IR_State | Samples(0s/20) | Cmd | Notes
# ----------------------------------------------------------------------
#     1 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#     2 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#     3 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#     4 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#     5 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#     6 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#     7 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#     8 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#     9 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    10 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    11 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    12 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    13 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    14 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    15 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    16 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    17 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    18 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    19 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    20 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    21 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    22 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    23 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    24 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    25 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    26 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    27 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    28 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    29 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    30 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    31 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    32 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    33 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    34 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    35 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    36 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    37 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    38 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    39 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    40 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    41 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    42 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    43 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    44 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    45 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    46 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    47 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    48 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    49 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    50 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    51 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    52 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    53 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    54 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    55 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    56 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    57 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    58 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    59 | DETECT | 20/20 (100%) | <75,0>     | >>> IR DETECTED! STOPPING
#    60 | DETECT | 20/20 (100%) | <75,0>     | 
#    61 | DETECT | 20/20 (100%) | <75,0>     | 
#    62 | DETECT | 20/20 (100%) | <75,0>     | 
#    63 | CLEAR  |  0/20 (  0%) | <75,1>     | >>> IR CLEARED! RESUMING
#    64 | DETECT | 20/20 (100%) | <75,0>     | >>> IR DETECTED! STOPPING
#    65 | CLEAR  |  0/20 (  0%) | <75,1>     | >>> IR CLEARED! RESUMING
#    66 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    67 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    68 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    69 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    70 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    71 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    72 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    73 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    74 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    75 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    76 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    77 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    78 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    79 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    80 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    81 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    82 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    83 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    84 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    85 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    86 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    87 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    88 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    89 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    90 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    91 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    92 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    93 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    94 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    95 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    96 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    97 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    98 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#    99 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   100 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   101 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   102 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   103 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   104 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   105 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   106 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   107 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   108 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   109 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   110 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   111 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   112 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   113 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   114 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   115 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   116 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   117 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   118 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   119 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   120 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   121 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   122 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   123 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   124 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   125 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   126 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   127 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   128 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   129 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   130 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   131 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   132 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   133 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   134 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   135 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   136 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   137 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   138 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   139 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   140 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   141 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   142 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   143 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   144 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   145 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   146 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   147 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   148 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   149 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   150 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   151 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   152 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   153 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   154 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   155 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   156 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   157 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   158 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   159 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   160 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   161 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   162 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   163 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   164 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   165 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   166 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   167 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   168 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   169 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   170 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   171 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   172 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   173 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   174 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   175 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   176 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   177 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   178 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   179 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   180 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   181 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   182 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   183 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   184 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   185 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   186 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   187 | CLEAR  |  0/20 (  0%) | <75,1>     | 
#   188 | CLEAR  |  0/20 (  0%) | <75,1>     | 





#!/usr/bin/env python3
"""
IR Scanning Test with Panning Motion
- Pans back and forth within ~90 degree range
- Stops when IR beacon detected
- Holds for 0.5s minimum before resuming
"""
import serial
import time
import RPi.GPIO as GPIO
import asyncio

# -------------------------------
# GPIO Setup
# -------------------------------
SENSOR_1 = 17  

GPIO.setmode(GPIO.BCM)
GPIO.setup(SENSOR_1, GPIO.IN, pull_up_down=GPIO.PUD_UP)

# -------------------------------
# Panning Configuration
# -------------------------------
PAN_SPEED = 75           # Motor speed for panning
PAN_DURATION = 1.5       # Seconds to pan in each direction (~90 deg total range)
STOP_DURATION = 0.5      # Minimum stop time when beacon detected

class IRMonitor:
    def __init__(self, pin, samples=20):
        self.pin = pin
        self.samples = samples
        self.state = 1  # 1 = beam unbroken, 0 = beam blocked

    def read_stable(self):
        vals = [GPIO.input(self.pin) for _ in range(self.samples)]
        zeros = vals.count(0)  # Count "detected" samples (LOW)

        # Hysteresis Logic (20% detect, 10% clear)
        if self.state == 1:  # Currently NOT DETECTED (Moving)
            # Require >=20% signal to stop (>=4 out of 20 samples)
            if zeros >= self.samples * 0.2:
                self.state = 0
        else:  # Currently DETECTED (Stopped)
            # Require <10% signal to start moving again (<2 out of 20 samples)
            if zeros < self.samples * 0.1:
                self.state = 1
                
        return self.state


class PanningScanner:
    """
    Simple scanner - sends constant speed to Arduino
    Arduino handles all panning direction control via encoders
    """
    def get_motor_command(self):
        """Return constant motor speed - Arduino controls direction"""
        return PAN_SPEED  # Always send positive speed, Arduino handles reversing


async def main():
    print("=" * 50)
    print("IR PANNING SCANNER TEST - DEBUG MODE")
    print("=" * 50)
    print(f"Pan range: ~90 deg (+/- 45 deg from center)")
    print(f"Pan speed: {PAN_SPEED}")
    print(f"Stop hold time: {STOP_DURATION}s")
    print("=" * 50)

    print("Opening serial connection...")
    try:
        ser = serial.Serial('/dev/ttyACM0', 115200, timeout=1)
        print("Serial connection opened!")
        ser.reset_input_buffer()
        print("Input buffer cleared")
    except Exception as e:
        print(f"ERROR opening serial port: {e}")
        print("Make sure Arduino is connected and code is uploaded")
        GPIO.cleanup()
        return

    print("Initializing monitors...")
    ir_monitor = IRMonitor(SENSOR_1, samples=20)
    scanner = PanningScanner()
    print("Ready to start panning!")
    print("=" * 50)
    print("DEBUG: Loop | IR_State | Samples(0s/20) | Cmd | Notes")
    print("-" * 70)
    
    loop_count = 0
    last_ir_state = ir_monitor.state
    last_command = ""

    try:
        while True:
            loop_start = time.time()
            
            # Read IR sensor with sample tracking
            vals = [GPIO.input(SENSOR_1) for _ in range(20)]
            zeros = vals.count(0)
            prev_state = ir_monitor.state
            
            # Manual hysteresis logic with tracking
            if ir_monitor.state == 1:  # Currently NOT DETECTED
                if zeros >= 4:  # 20% threshold
                    ir_monitor.state = 0
            else:  # Currently DETECTED
                if zeros < 2:  # 10% threshold
                    ir_monitor.state = 1
            
            ir_state = ir_monitor.state
            
            # Get motor command
            motor_speed = scanner.get_motor_command()
            
            # Send command to Arduino
            command = f"<{motor_speed},{ir_state}>"
            ser.write(command.encode())
            
            # Detect state changes
            state_changed = (ir_state != prev_state)
            command_changed = (command != last_command)
            
            # Print debug info every loop OR when state changes
            notes = []
            if state_changed:
                if ir_state == 0:
                    notes.append(">>> IR DETECTED! STOPPING")
                else:
                    notes.append(">>> IR CLEARED! RESUMING")
            
            # Print every loop for detailed tracking
            loop_count += 1
            state_str = "DETECT" if ir_state == 0 else "CLEAR "
            print(f"{loop_count:5d} | {state_str} | {zeros:2d}/20 ({zeros*5:3d}%) | {command:10s} | {' '.join(notes)}")
            
            last_ir_state = ir_state
            last_command = command
            
            # Sleep to maintain 10Hz
            elapsed = time.time() - loop_start
            sleep_time = max(0, 0.1 - elapsed)
            await asyncio.sleep(sleep_time)

    except KeyboardInterrupt:
        print("\n\nExiting...")
        ser.write(b"<0,1>")  # Stop motors
        GPIO.cleanup()
        ser.close()


if __name__ == "__main__":
    asyncio.run(main())

